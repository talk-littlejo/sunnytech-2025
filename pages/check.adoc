=  VÃ©rification en conditions rÃ©elles
:imagesdir: assets/default/images
image::mi-check.png[]

[NOTE.speaker]
====
On a rÃ©solu le problÃ¨me de la crÃ©ation de connexion pour un nombre important de cluster.

On commence Ã  se rapprocher dangereusement de notre but.

Il est temps de vÃ©rifier que les clusters sont bien fonctionnels et qu'ils peuvent bien communiquer.
====

== ğŸ•µï¸ Surveillance passive

[source,bash]
----
cilium status
cilium clustermesh status
----

image::terminal-cilium-status.svg[]

[NOTE.speaker]
====
Ainsi on a les lignes de commande cilium status et cilium clustermesh status qui permettent d'avoir l'Ã©tat du cluster.

* trop verbeux
* ğŸš« pas une **preuve de connectivitÃ©**
====

== ğŸ§¬ Analyse poussÃ©e

[source,bash]
----
cilium status -o json
cilium clustermesh status -o json
----

[NOTE.speaker]
====
Une rÃ©ponse au premier problÃ¨me, il est possible de changer la sortie standard d'avoir une sortie en json et ainsi :

* ğŸ“Š DonnÃ©es plus exploitables
* ğŸ¤– IdÃ©al pour un tableau de bord
* ğŸš« Toujours pas une **preuve de connectivitÃ©**
====

== Test de connectivitÃ©

[source,bash]
----
cilium connectivity test --context cluster1 --multi-cluster cluster2
----

image::clustermesh-test.svg[width=80%]

[NOTE.speaker]
====
Pour la connectivitÃ© il y a cilium connectivity test.

* ğŸ” Lance une **batterie de tests**

* Le test ne vÃ©rifie que **1 âœ 2**
  * Pas de retour automatique **2 âœ 1**
====

== DÃ©veloppement dâ€™un outil de test

* Modifier la cilium cli :

[source,bash]
----
cilium connectivity test --context cluster1 --multi-cluster cluster[2-511]
----

* Utiliser **Terratest**

[NOTE.speaker]
====
Deux options s'offrent Ã  moi :

* La solution naturelle : modifier la cilium cli
* La solution astucieuse : Terratest
====

== Terratest

image::clustermesh-terratest.svg[width=80%]

[NOTE.speaker]
====
Terratest est un projet Ã  l'origine pour tester du code Terraform
La prise en main est facile mais il faut connaÃ®tre le go. J'ai donc choisi cet outil.

J'ai crÃ©Ã© 5 tests diffÃ©rents.

Par exemple celui-ci, il comporte :

* client par cluster
* serveur par cluster
* le client requÃªte jusqu'Ã  ce qu'il ait rÃ©ussi Ã  joindre tous les clusters


* Avec ce test, on peut vÃ©rifier si les clusters peuvent joindre tous les autres clusters.

====
