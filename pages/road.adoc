= ğŸš€ En route vers les 256 clusters
:imagesdir: assets/default/images
image::mi-plane.png[]
[NOTE.speaker]
====
Maintenant qu'on a dÃ©fini le terrain d'action et ses difficultÃ©s. Concentrons nous sur le problÃ¨me principal pour aller jusqu'Ã  256 clusters.
====

== CrÃ©ation des connexions ğŸ§¨
image::code-cilium-cli.png[width=80%]

[NOTE.speaker]
====
Les connexions.

Voici le code principal de la crÃ©ation de connexion.

Nous allons expliquer comment fonctionne ce bout de code.
====

== !

image::deploy-connection-get-1.svg[width=50%]

[NOTE.speaker]
====
* ğŸ“¡ Extraction des donnÃ©es de Cluster Mesh sur le cluster rouge.
* C'est l'Ã©quivalent d'un kubectl get en langage Go
* Cette Ã©tape dure moins d'une seconde
====

== !

image::deploy-connection-get-2.svg[width=50%]
[NOTE.speaker]
====
* Idem pour le cluster jaune
====

== !

image::deploy-connection-upgrade-1.svg[width=40%]
[NOTE.speaker]
====
* ğŸ”§ Mise Ã  jour de la config sur le cluster rouge avec les donnÃ©es du cluster jaune
* C'est l'Ã©quivalent d'un helm upgrade en langage Go
* Cette Ã©tape dure environ 7 secondes
====

== !

image::deploy-connection-upgrade-2.svg[width=40%]
[NOTE.speaker]
====
* Idem pour le cluster jaune

ğŸ¤” "On peut parallÃ©liser les helm upgrade, non ?"

ğŸ’¥ RÃ©sultat : CPU en feu.
====

== GÃ©nÃ©ralisation pour n clusters

* ğŸ“¡ Extraction des donnÃ©es (par cluster)
* ğŸ”§ Mise Ã  jour de la config (par cluster)

[NOTE.speaker]
====
Il faut plutÃ´t gÃ©nÃ©raliser la mÃ©thode pour n clusters que pour seulement 2 clusters :

* On va rÃ©cupÃ©rer les donnÃ©es de tous les clusters
* On va mettre Ã  jour le premier clusters avec les donnÃ©es des autres clusters
* On va mettre Ã  jour le deuxiÃ¨me clusters avec les donnÃ©es des autres clusters
* Etc

====

== La Pull Request

image::pr.png[]

[NOTE.speaker]
====
C'est l'objectif de cette PR.

En thÃ©orie : pour 511 clusters on mettrait environ une heure
====

== ğŸ§ª **32 clusters**

image::32-clusters.apng[width=50%]

[NOTE.speaker]
====
Maintenant que la PR a Ã©tÃ© mergÃ©, nous allons pouvoir tester cela sur un nombre important de clusters : 32.

Nous voyons schÃ©matiquement la mise Ã  jour de chaque cluster et de ses connexions.

Le dÃ©ploiement s'est bien passÃ© mais en combien de temps ?
====

== !

[cols="1,1", options="header"]
|===
| Ã‰tape | DurÃ©e

| ğŸ”§ *CrÃ©ation connexions*
| 5 minutes

| â³ *DÃ©ploiement total*
| 17 minutes

|===

[NOTE.speaker]
====
Voici les rÃ©sultats du dÃ©ploiement.

On met 5 minutes pour la crÃ©ation de connexion. Ce qui nous ferait environ 80 minutes pour 511 clusters probablement trop pour notre objectif de 4 heures.

Les helm upgrade prennent beaucoup de temps. Pourquoi ne pas les parallÃ©liser sans saturÃ© le serveur.
====

== ParallÃ©lisation

image::pr-2.png[]

[NOTE.speaker]
====
C'est l'objet de cette PR.

En suivant les durÃ©es observÃ©es avec 32 clusters : avec 16 tÃ¢ches en parallÃ¨le on pourrait crÃ©er les connexions de 511 clusters en 5 minutes.
====

== ğŸ§ª **64 clusters**

image::64-clusters.apng[width=50%]

[NOTE.speaker]
====
Maintenant que la PR est mergÃ©, on va tester cela sur 64 clusters.

Nous voyons schÃ©matiquement la mise Ã  jour en parallÃ¨le de deux clusters et de ses connexions. Concernant le dÃ©ploiement, on a parallÃ©lisÃ© 7 fois la tÃ¢che des helm upgrades.

Le dÃ©ploiement s'est Ã©galement bien passÃ© avec 64 clusters.

Voyons si cette optimisation va payer.
====

== !

[cols="1,1,1", options="header"]
|===
| Clusters | DÃ©ploiement | Connexions

| pass:[<span style="color:gray;">32</span>]
| pass:[<span style="color:gray;">17 minutes</span>]
| pass:[<span style="color:gray;">5 minutes</span>]

| pass:[<strong><span style="color:#3366cc;">64</span></strong>]
| pass:[<strong><span style="color:#3366cc;">15 minutes</span></strong>]
| pass:[<strong><span style="color:#3366cc;">2 minutes</span></strong>]

|===

[NOTE.speaker]
====
Nous avont rÃ©ussi Ã  gagner 2 minutes sur le temps de dÃ©ploiement de 64 clusters et 3 minutes sur le temps de crÃ©ation de connexion.

Si la tendance continue, on pourrait connecter 511 clusters en seulement 16 minutes.

ğŸ‘‰ Lâ€™objectif des 4 heures semble Ãªtre atteignable.
====
